import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter_spinkit/flutter_spinkit.dart';
import 'package:hive/hive.dart';
import 'package:pentesting/CommonHelper/BusinessLogic.dart';
import 'package:provider/provider.dart';
import '../CommonHelper/SingleMyOrderHistoryContainer.dart';
import '../Providers/CartProvider.dart';

class OrderHistoryScreen extends StatefulWidget {
  const OrderHistoryScreen({super.key});

  @override
  State<OrderHistoryScreen> createState() => _OrderHistoryScreenState();
}

class _OrderHistoryScreenState extends State<OrderHistoryScreen> {



  BusinessLogic bl = BusinessLogic();

  @override
  Widget build(BuildContext context) {
    var orderprovider = Provider.of<CartProvider>(context,listen: false);
    var orderitemslist = orderprovider.GetOrderHistoryList();
    print("Order Items List Is ${orderitemslist}");
    return Scaffold(
      appBar: AppBar(
        title: Text("Order History"),
        actions: [
          GestureDetector(
              onTap: () async{
                var box =await Hive.openBox("OrdersHistoryBox");
                box.clear();
                orderprovider.orderhistorylist.clear();
                ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Order History Cleared")));
                setState(()  {});
              },
              child: Icon(Icons.delete,color: Colors.red,)),
          SizedBox(width: 8,)
        ],
      ),
      body: FutureBuilder(
        future: bl.GetOrderHistoryList(),
        builder: (context,snapshot){
          if(snapshot.hasData==false || orderprovider.orderhistorylist.length==0){
            return EmptyBox();
          }

          if(snapshot.connectionState == ConnectionState.waiting){
            return Center(child: SpinKitHourGlass(color: Colors.green));
          }else if(snapshot.connectionState==ConnectionState.active || snapshot.connectionState==ConnectionState.done){
            return  ListView.builder(
                itemCount: bl.orderhistorylist.length,
                itemBuilder: (context,index){
                  return SingleMyOrderHistoryContainer(
                    Date: bl.orderhistorylist[index][0],
                    Total: bl.orderhistorylist[index][1].toString(),
                    Discount: bl.orderhistorylist[index][2].toString(),
                    Payable: bl.orderhistorylist[index][3].toString(),
                    itemslist: bl.orderhistorylist[index][4],
                  );
                });
          }
          else{
            return EmptyBox();
          }
        },
      ),
    );
  }

  EmptyBox() {
    return Container(
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Image.asset('Assets/Images/basket.png',height: 180,width: 150,),
            SizedBox(height: 10,),
            Text(("No Order History Found "),style: TextStyle(fontSize: 25,fontWeight: FontWeight.bold),)
          ],
        ),
      ),
    );
  }
}
